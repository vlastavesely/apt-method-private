HELPER = private
ENCODER = tools/encoder
TESTPROG = tests/test

CC              = @CXX@
INSTALL         = @INSTALL@
INSTALL_DATA    = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
MKDIR_P         = @MKDIR_P@

prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
libdir      = @exec_prefix@/lib
docdir      = @docdir@
datarootdir = @datarootdir@
mandir      = @mandir@

CFLAGS = @OPENSSL_CFLAGS@ @CURL_CFLAGS@ -Wall -O2 -std=c++20
LFLAGS = @OPENSSL_LIBS@ @CURL_LIBS@

TESTCFLAGS = @CHECK_CFLAGS@ $(CFLAGS)
TESTLFLAGS = @CHECK_LIBS@ $(LFLAGS)

OBJECTS = private-method.o acquire-method.o stanza.o config-file.o	\
	uri.o hash.o hex.o fetch.o filter.o cipher.o origin.o random.o

TESTSOURCES = $(wildcard tests/*.cpp)
TESTOBJECTS = $(OBJECTS) $(TESTSOURCES:%.cpp=%.o)

AUX_FILES = Makefile configure aclocal.m4 install-sh config.h* *.log	\
	*.status *.cache

all: $(HELPER) $(TESTPROG) $(ENCODER)

include $(wildcard *.d */*.d)

$(HELPER): main.o $(OBJECTS)
	$(QUIET_LD) $(CC) $^ -o $@ $(LFLAGS)

$(ENCODER): tools/encoder.o $(OBJECTS)
	$(QUIET_LD) $(CC) $^ -o $@ $(LFLAGS)

%.o: %.cpp
	$(QUIET_CC) $(CC) -MMD -MP -c $< -o $@ $(CFLAGS)

tests/%.o: tests/%.cpp
	$(QUIET_CC) $(CC) -MMD -MP -c $< -o $@ $(TESTCFLAGS)

$(TESTPROG): $(TESTOBJECTS)
	$(QUIET_LD) $(CC) $^ -o $@ $(TESTLFLAGS)

test: $(TESTPROG)
	$(TESTPROG)

install:
	$(MKDIR_P) $(bindir) $(libdir)/apt/methods
	$(INSTALL_PROGRAM) tools/encoder -T $(bindir)/apt-private-prepare
	$(INSTALL_PROGRAM) private $(libdir)/apt/methods

uninstall:
	$(RM) $(DESTDIR)/usr/bin/apt-private-prepare
	$(RM) $(DESTDIR)/usr/lib/apt/methods/private

clean:
	$(RM) $(HELPER) $(ENCODER) $(TESTPROG) *.o *.d */*.o */*.d

clean-aux:
	$(RM) -r $(AUX_FILES)

distclean: clean clean-aux


ifndef V
QUIET_CC    = @echo "  CC     $@";
QUIET_LD    = @echo "  CCLD   $@";
QUIET_AR    = @echo "  AR     $@";
QUIET_GEN   = @echo "  GEN    $@";
endif
